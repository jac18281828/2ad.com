name: Release Deploy
on:
  push:
    tags:
      - "*"
  workflow_dispatch:
permissions:
  id-token: write
  contents: write
concurrency:
  group: "release-deploy-${{ github.ref }}"
  cancel-in-progress: true
env:
  AWS_REGION: "us-east-1"
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.16.0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install Node dependencies
        run: npm ci
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -s requirements.txt ]; then
            pip install -r requirements.txt
          fi
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          audience: sts.amazonaws.com
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: arn:aws:iam::504242000181:role/GithubDeployCI
      - name: Deploy infrastructure
        run: npm run cdk:deploy -- --all --require-approval never --outputs-file cdk-outputs.json --no-telemetry
      - name: Build static sites
        run: ./scripts/build-sites.sh
      - name: Sync static sites to S3 and invalidate CloudFront
        run: ./scripts/s3-sync-sites.sh cdk-outputs.json
      - name: GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body_path: CHANGELOG.md
          generate_release_notes: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
